name: AI Issue Support

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  respond:
    if: github.event.issue.user.type != 'Bot'
    runs-on: ubuntu-latest
    environment: copilot
    steps:
      - name: Checkout ChatControl
        uses: actions/checkout@v4
        with:
          path: chatcontrol

      - name: Checkout Foundation
        uses: actions/checkout@v4
        with:
          repository: kangarko/foundation
          path: foundation

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Copilot CLI
        run: npm install -g @github/copilot

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Copilot SDK
        run: pip install github-copilot-sdk

      - name: Fix bundled CLI permissions
        run: chmod +x "$(python -c 'import copilot, os; print(os.path.join(os.path.dirname(copilot.__file__), "bin", "copilot"))')"

      - name: Analyze issue and generate response
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ',') }}
        run: python chatcontrol/.github/scripts/issue_responder.py

      - name: Create fix PR if changes were proposed
        id: fix_pr
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          cd chatcontrol
          if git diff --quiet; then
            echo "No code changes proposed"
            exit 0
          fi

          BRANCH="fix/issue-${ISSUE_NUM}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "Proposed fix for #${ISSUE_NUM}"
          git push -f origin "$BRANCH"

          EXISTING_PR=$(gh pr list --head "$BRANCH" --json url --jq '.[0].url' 2>/dev/null || true)

          if [ -n "$EXISTING_PR" ]; then
            echo "pr_url=$EXISTING_PR" >> "$GITHUB_OUTPUT"
          else
            PR_URL=$(gh pr create \
              --draft \
              --title "Fix #${ISSUE_NUM}: ${ISSUE_TITLE}" \
              --body-file ../pr_description.md \
              --head "$BRANCH")
            echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          fi

      - name: Append PR link to response
        if: steps.fix_pr.outputs.pr_url
        run: |
          printf '\n\n---\n:memo: **A draft fix has been proposed:** %s\n*Please review before merging.*' "${{ steps.fix_pr.outputs.pr_url }}" >> response.md

      - name: Post response comment
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment "${{ github.event.issue.number }}" \
            --repo "${{ github.repository }}" \
            --body-file response.md

      - name: Post failure diagnostic
        if: failure() && hashFiles('failure.md') != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment "${{ github.event.issue.number }}" \
            --repo "${{ github.repository }}" \
            --body-file failure.md
